<!DOCTYPE html>






  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="fengbeihong">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="fengbeihong">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fengbeihong">






  <link rel="canonical" href="http://yoursite.com/page/2/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>fengbeihong</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fengbeihong</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/07/bash-shell-tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengbeihong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fengbeihong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/07/bash-shell-tips/" itemprop="url">
                  Bash Shell Tips
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-07 07:56:15 / Modified: 17:57:41" itemprop="dateCreated datePublished" datetime="2018-01-07T07:56:15+08:00">2018-01-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对企业级产品里的脚本中常用shell做个记录，平时不写shell很少注意到。</p>
<h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><p>控制环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set -o errexit -o nounset -o pipefail</span><br></pre></td></tr></table></figure></p>
<h2 id="shift"><a href="#shift" class="headerlink" title="shift"></a>shift</h2><p>用来修改参数数组<code>$@</code><br>假设执行shell命令<code>bash test.sh 1 2 3 4 5</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">echo $@  # 1 2 3 4 5</span><br><span class="line"></span><br><span class="line">shift</span><br><span class="line"># 等同于shift 1</span><br><span class="line">echo $@  # 2 3 4 5</span><br><span class="line"></span><br><span class="line">shift</span><br><span class="line">echo $@  # 3 4 5</span><br><span class="line"></span><br><span class="line">shift 2</span><br><span class="line">echo $@  # 5</span><br></pre></td></tr></table></figure></p>
<p>可以看到shift可以加参数也可以不加，加参数就是从当前参数数组的第几个参数开始截断</p>
<h2 id="0"><a href="#0" class="headerlink" title="$? $0 $@"></a>$? $0 $@</h2><p>返回值，参数，默认值等等<br>${4:-$COMMAND}</p>
<h2 id="declare"><a href="#declare" class="headerlink" title="declare"></a>declare</h2><p>声明参数<br>尤其是声明全局参数</p>
<h2 id="if"><a href="#if" class="headerlink" title="if"></a>if</h2><p>判断表达式的用法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if [ -d /test_dir/ ]; then</span><br><span class="line">    # 检测目录是否存在</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -f /test_file ]; then</span><br><span class="line">    # 检测文件是否存在</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -z $TEST_VAL ]; then</span><br><span class="line">    # 如果变量为空</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<p>比较两个浮点型变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$s1=10</span><br><span class="line">$s2=9</span><br><span class="line"></span><br><span class="line">echo $s1&apos;&gt;&apos;$s2 | bc -l</span><br><span class="line">0</span><br><span class="line">echo $s2&apos;&gt;&apos;$s1 | bc -l</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$s1=10</span><br><span class="line">$s2=10</span><br><span class="line"></span><br><span class="line">echo $s1&apos;&gt;&apos;$s2 | bc -l</span><br><span class="line">0</span><br><span class="line">echo $s2&apos;&gt;&apos;$s1 | bc -l</span><br><span class="line">0</span><br></pre></td></tr></table></figure></p>
<h2 id="trap"><a href="#trap" class="headerlink" title="trap"></a>trap</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trap - INT</span><br></pre></td></tr></table></figure>
<h2 id="tr"><a href="#tr" class="headerlink" title="tr"></a>tr</h2><p><code>tr</code></p>
<h2 id="cut"><a href="#cut" class="headerlink" title="cut"></a>cut</h2><p><code>cut</code></p>
<h2 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOM</span><br><span class="line">EOM</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="local"><a href="#local" class="headerlink" title="local"></a>local</h2><p><code>local</code></p>
<h2 id="echo-e"><a href="#echo-e" class="headerlink" title="echo -e"></a>echo -e</h2><p><code>echo -e</code></p>
<h2 id="case-esac"><a href="#case-esac" class="headerlink" title="case esac"></a>case esac</h2><p><code>case esac</code></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/07/solum简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengbeihong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fengbeihong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/07/solum简介/" itemprop="url">
                  Solum简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-07 07:53:23 / Modified: 17:59:44" itemprop="dateCreated datePublished" datetime="2018-01-07T07:53:23+08:00">2018-01-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>solum是部署web application的项目。<br>web app都是跑在各种web server中，所以solum的操作就分为了languagepack和app两个部分。</p>
<p>solum的作用</p>
<ul>
<li>搭建自动测试系统，并且可以设置在多个版本的runtime环境中进行测试。</li>
<li>自动化部署</li>
<li>应用开发的整个生命周期管理</li>
<li>上述这些都可以和github和docker的特性结合起来，快捷方便</li>
<li>CI/CD</li>
</ul>
<p>下面是部署部署一个app的流程的用到的命令总览：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ solum languagepack create &lt;NAME&gt; &lt;GIT_REPO&gt;</span><br><span class="line">$ solum languagepack show &lt;UUID/Name&gt;</span><br><span class="line">$ solum languagepack logs &lt;UUID&gt;</span><br><span class="line">$ solum languagepack list</span><br><span class="line">$ solum app create --app-file &lt;app_file&gt; [--param-file param_file]</span><br><span class="line">$ solum app show &lt;UUID/Name&gt;</span><br><span class="line">$ curl &lt;application_uri&gt;</span><br></pre></td></tr></table></figure>
<h3 id="languagepack"><a href="#languagepack" class="headerlink" title="languagepack"></a>languagepack</h3><p>这个步骤可以创建python、java或其他语言的web应用运行环境。<br>languagepack需要指定一个git repo，下载Dockerfile和build.sh。</p>
<ul>
<li>Dockerfile用来创建docker image。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:14.04</span><br><span class="line"></span><br><span class="line">RUN apt-get -yqq update</span><br><span class="line">RUN apt-get -yqq install python-pip</span><br><span class="line">RUN apt-get -yqq install python-dev</span><br><span class="line"></span><br><span class="line">COPY build.sh /solum/bin/</span><br></pre></td></tr></table></figure>
<ul>
<li>build.sh用来在创建app时执行。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># Check if pip is installed</span><br><span class="line">pip help</span><br><span class="line">[[ $? != 0 ]] &amp;&amp; echo python-pip is not installed. &amp;&amp; exit 1</span><br><span class="line"></span><br><span class="line"># Install dependencies from app requirements file</span><br><span class="line">cd /app</span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>
<h3 id="app"><a href="#app" class="headerlink" title="app"></a>app</h3><p>创建app会包含一个workflow流程，根据已有的languagepack创建最终的deployment unit(DU)，然后用heat去部署.</p>
<h4 id="deployment-unit-DU"><a href="#deployment-unit-DU" class="headerlink" title="deployment unit(DU)"></a>deployment unit(DU)</h4><p>DU就是一个打包好的安装了运行环境和application的docker image，可以直接用来创建container运行。<br>当然这个docker image需要languagepack和app两个步骤最终完成创建。</p>
<h4 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h4><ul>
<li>unittest</li>
<li>build</li>
<li>deploy</li>
</ul>
<p>标准的三个步骤，但是这个三个步骤可以选择性的执行，比如只执行unittest和build.</p>
<p>workflow的相关信息都是在appfile.yaml里定义，由参数–app-file指定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version: 1</span><br><span class="line">name: cherrypy</span><br><span class="line">description: python web app</span><br><span class="line">languagepack: python</span><br><span class="line">source:</span><br><span class="line">  repository: https://github.com/rackspace-solum-samples/solum-python-sample-app.git</span><br><span class="line">  revision: master</span><br><span class="line">workflow_config:</span><br><span class="line">  test_cmd: ./unit_tests.sh  # 在unittest步骤里执行什么命令</span><br><span class="line">  run_cmd: python app.py  # 在build步骤执行什么命令</span><br><span class="line">trigger_actions:</span><br><span class="line"> - unittest</span><br><span class="line"> - build</span><br><span class="line"> - deploy  # 就是nova boot的步骤，不过这个依赖nova-docker</span><br><span class="line">ports:</span><br><span class="line"> - 80</span><br></pre></td></tr></table></figure>
<ul>
<li>unittest会根据LP去执行<code>docker build</code>，执行unittest脚本，但是不会保存到glance或swift里</li>
<li>build这个步骤，根据LP执行<code>docker build</code>，执行build.sh脚本，最终保存到glance或swift里</li>
<li>deploy就是通过heat进行nova boot的步骤，依赖nova-docker驱动，从neutron申请IP，从glance下载image。这些取代了直接通过docker的api进行创建容器。<br>这个步骤可以和k8s、mesos以及swarm结合使用。<br>solum的配置文件中有这个参数：<code>docker_daemon_url = unix://var/run/docker.sock</code><br>solum的对docker的操作，都是通过url的remote API进行请求的。那么，对于docker服务，可以是单独的docker服务，也可以是k8s之类的集群，只要提供和docker一致的API。</li>
</ul>
<blockquote>
<p><a href="https://wiki.openstack.org/wiki/Solum/configurations" target="_blank" rel="noopener">https://wiki.openstack.org/wiki/Solum/configurations</a> solum的deploy可以基于docker部署，也可以基于VM</p>
</blockquote>
<ul>
<li>docker<ul>
<li>设置nova-docker驱动 <code>/etc/nova/nova.conf</code>: compute_driver = novadocker.virt.docker.driver.DockerDriver</li>
<li>把solum的存储项设置为glance <code>/etc/solum/solum.conf</code> image_storage = glance</li>
<li>最后部署的时候需要用<code>basic</code>heat template，<a href="https://github.com/openstack/solum/blob/master/etc/solum/templates/basic.yaml" target="_blank" rel="noopener">https://github.com/openstack/solum/blob/master/etc/solum/templates/basic.yaml</a></li>
</ul>
</li>
<li>VM<ul>
<li><code>/etc/nova/nova.conf</code> compute_driver = libvirt.LibvirtDriver</li>
<li><code>/etc/solum/solum.conf</code> image_storage = swift，image_format = vm</li>
</ul>
</li>
</ul>
<p>当用VM在solum里部署应用时，步骤比较绕</p>
<ul>
<li>用disk-image-builder创建带有docker的VM image</li>
<li>用这个image创建docker的container，再通过docker的api去安装app的源码，进行测试等操作，最后把image保存到glance</li>
<li>最终用这个image部署在VM上</li>
</ul>
<h4 id="param-file"><a href="#param-file" class="headerlink" title="param_file"></a>param_file</h4><p>在<code>solum app create</code>时也可以用–param-file指定想要inject的参数<br>这些参数可以通过build步骤里命令脚本去操作</p>
<h3 id="app代码的自动更新部署"><a href="#app代码的自动更新部署" class="headerlink" title="app代码的自动更新部署"></a>app代码的自动更新部署</h3><p>app的代码也在git里，而且可以在自己的git里设置hook，在提交代码后，自动向这个web app的地址发送一个POST请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.2.15:9777/v1/triggers/&lt;trigger_id&gt;</span><br></pre></td></tr></table></figure>
<p>solum会自动重新build一个新的image然后重新部署app</p>
<p>如果是github的源码，在project的设置里可以设定这个trigger url</p>
<h3 id="devstack开发环境"><a href="#devstack开发环境" class="headerlink" title="devstack开发环境"></a>devstack开发环境</h3><p>一共有两种方式，一种用vagrant一种用devstack，直接devstack就可以。</p>
<p>wiki文档地址：<a href="https://wiki.openstack.org/wiki/Solum/solum-development-setup" target="_blank" rel="noopener">https://wiki.openstack.org/wiki/Solum/solum-development-setup</a></p>
<ul>
<li>local.conf文件直接从它提供的外网地址下载</li>
<li>local.conf的配置尤其是密码最好别变，有的服务的密码没有做成可配置，仍然是默认的solum，改动会导致后续的验证失败。</li>
<li>nova和neutron先手动下载源码后再git checkout到指定的change id里，应该是最新代码还没测试完。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/07/DCOS和mesos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengbeihong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fengbeihong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/07/DCOS和mesos/" itemprop="url">
                  DCOS和mesos
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-07 07:53:06 / Modified: 18:06:17" itemprop="dateCreated datePublished" datetime="2018-01-07T07:53:06+08:00">2018-01-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Mesos"><a href="#Mesos" class="headerlink" title="Mesos"></a>Mesos</h3><p>mesos本身的目的是针对当前的各种分布式系统的抽象，拿原始的操作系统进行对比，内核控制各个进程执行某些任务，而到了分布式时代，要从更高层面去看，把每个物理节点当做一个进程，有专门的服务作为抽象的内核对进程进行调控，分配给各个进程去执行任务，就像下面的图，特别像操作系统的概念。<br><img src="https://docs.mesosphere.com/1.10/img/dcos-architecture-layers.png" alt="mesos架构"></p>
<h3 id="DC-OS"><a href="#DC-OS" class="headerlink" title="DC/OS"></a>DC/OS</h3><p>Data Center Operating System<br>算是mesos的超集，采用了mesos的kernel，然后把mesos中常用的framework(mesos中的概念，表示进程要执行的任务，具体到节点就是mesos的某些agent节点组成的安装的具体的分布式软件)整合到了dcos中，并且提供了良好的界面和CLI，也继承了许多企业级服务如marathon和chronos等，用dcos来完成mesos的data center功能十分高效便捷。</p>
<p><a href="https://support.mesosphere.com/hc/en-us/articles/205097325-How-is-the-Mesosphere-DCOS-different-from-Apache-Mesos-" target="_blank" rel="noopener">https://support.mesosphere.com/hc/en-us/articles/205097325-How-is-the-Mesosphere-DCOS-different-from-Apache-Mesos-</a></p>
<h3 id="DC-OS是运行容器的最好方式"><a href="#DC-OS是运行容器的最好方式" class="headerlink" title="DC/OS是运行容器的最好方式"></a>DC/OS是运行容器的最好方式</h3><p><a href="https://mesosphere.com/blog/2016/04/19/open-source-dcos/" target="_blank" rel="noopener">https://mesosphere.com/blog/2016/04/19/open-source-dcos/</a></p>
<p>mesos可以安装运行各种分布式软件，当然也包括docker，不过在最新的mesos1.0中，mesos也实现了自己的容器化技术，就算不安装docker也可以跑容器了。当然，这些容器化技术大概在2015年都统一了标准，互相兼容的。</p>
<h3 id="mesos的手动配置"><a href="#mesos的手动配置" class="headerlink" title="mesos的手动配置"></a>mesos的手动配置</h3><p>按照magnum中的部署mesos环境的步骤，手动配置的话模板里会有以下和mesos相关的参数：</p>
<h3 id="magnum部署mesos的流程"><a href="#magnum部署mesos的流程" class="headerlink" title="magnum部署mesos的流程"></a>magnum部署mesos的流程</h3><ul>
<li>首先准备image文件，在image文件会安装好mesos服务所需的zookeeperd、mesos和marathon服务，以及docker-engine服务。</li>
<li>先启动magnum参数所指定的几个master虚拟机，启动完成后会对master节点的服务进行配置，并且启动这些服务。</li>
<li>然后启动agent节点，启动完成后会在节点内部创建<code>/etc/sysconfig/heat-params</code>文件，然后配置agent节点服务，启动服务，最后要等待执行<code>agent_wc_notify</code>操作，并且设置volume服务。</li>
</ul>
<h3 id="magnum中coe的设计思路"><a href="#magnum中coe的设计思路" class="headerlink" title="magnum中coe的设计思路"></a>magnum中coe的设计思路</h3><p>按照magnum里的coe的设计思路，是希望集群里所需要的软件都在image里安装好，之后只需要根据选项进行配置启动就可以。<br>那么如果把mesos换成dcos，dcos中涉及到的几十个应用也需要提前安装好，在部署完dcos后也可以随时安装卸载对应应用<br>这就得舍弃dcos提供的安装流程，相当于舍弃已经整合好的安装脚本，换成手动在magnum里重新实现一遍</p>
<h3 id="dcos的安装流程"><a href="#dcos的安装流程" class="headerlink" title="dcos的安装流程"></a>dcos的安装流程</h3><p>说下advanced安装方式，在每个节点进行执行的操作来手动执行</p>
<ul>
<li>先准备两个文件<code>ip-detect</code>和<code>config.yaml</code>，检测IP和进行集群的配置</li>
<li>下载安装脚本文件，这个shell文件里，其实除了脚本还包含了压缩包二进制文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -O https://downloads.dcos.io/dcos/EarlyAccess/commit/14509fe1e7899f439527fb39867194c7a425c771/dcos_generate_config.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>执行<code>dcos_generate_config.sh</code>脚本文件，默认的参数就是<code>--genconf</code>，生成了安装的配置信息，文件和路径信息就会如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── dcos-genconf.&lt;HASH&gt;.tar</span><br><span class="line">├── dcos_generate_config.sh</span><br><span class="line">├── genconf</span><br><span class="line">│   ├── serve</span><br><span class="line">│   │   ├── dcos_install.sh</span><br><span class="line">│   ├── config.yaml</span><br><span class="line">│   ├── ip-detect</span><br><span class="line">│   ├── cluster_packages.json</span><br><span class="line">│   ├── ssh_key</span><br><span class="line">│   ├── state</span><br></pre></td></tr></table></figure>
<ul>
<li>然后执行<code>docker run</code>，这一步会在bootstrap node启动一个nginx的容器服务，映射端口，并且把<code>./genconf/serve/</code>目录映射到nginx容器里的<code>/usr/share/nginx/html</code>，路径映射的结果就是，可以从其他节点访问nginx服务获取<code>serve</code>目录下的文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -d -p &lt;your-port&gt;:80 -v $PWD/genconf/serve:/usr/share/nginx/html:ro nginx</span><br></pre></td></tr></table></figure>
<ul>
<li>剩下的步骤就是登录到各个节点，master和agent节点，下载下来dcos_install.sh，然后执行安装就可以了<br>安装时要指定<code>role</code>，即当前机器为哪类节点，支持<code>master</code>，<code>slave</code>，<code>slave_public</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ssh &lt;master-ip&gt;</span><br><span class="line">$ mkdir /tmp/dcos &amp;&amp; cd /tmp/dcos</span><br><span class="line">$ curl -O http://&lt;bootstrap-ip&gt;:&lt;your_port&gt;/dcos_install.sh</span><br><span class="line">$ sudo bash dcos_install.sh master</span><br></pre></td></tr></table></figure>
<ul>
<li>最后一步就是等待安装完成并且各个节点之间同步完成，如何检测状态，查看<code>Exhibitor</code>服务的信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;master-ip&gt;:8181/exhibitor/v1/ui/index.html</span><br></pre></td></tr></table></figure>
<ul>
<li>现在可以启动DCOS的web界面</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;master-node-public-ip&gt;/</span><br></pre></td></tr></table></figure>
<h3 id="bootstrap-node"><a href="#bootstrap-node" class="headerlink" title="bootstrap node"></a>bootstrap node</h3><p>bootstrap节点是干啥的，在安装过程中都会先启动bootstrap node，把要安装的东西压下载到bootstrap node，生成配置文件，然后进行安装。<br>安装时也会通过某种方式把配置文件和安装脚本拷贝到master或者agent节点去，然后在具体的节点上执行安装。<br>文档说bootstrap node是集群的永久性节点，但是个人感觉不是必须的，只是集群必须有一个执行安装程序的节点，卸载时也会需要一个节点来跑执行程序，那么就放到了bootstrap node上，然后bootstrap node也提供了界面化的安装和卸载。<br>如果把安装放到magnum里去做，那么执行安装程序的操作就交给了magnum的HOT去做，拷贝文件也可以由magnum去做，卸载就是直接删除集群节点，整个流程就用不到bootstrap node了。<br>另外，在dcos官网的design页面看到，components需要提前下载，并且是在bootstrap node下载，并且build完成，打包，然后再copy到master或agent节点去安装。<br>那么如果修改的话就方便了，因为dcos_install.sh脚本做的工作就是一个下载，解压，修改配置文件和启动服务。之前的操作放置到DIB里去做。</p>
<h3 id="在安装过程中，master节点，agent节点和bootstrap节点都做了什么具体的工作"><a href="#在安装过程中，master节点，agent节点和bootstrap节点都做了什么具体的工作" class="headerlink" title="在安装过程中，master节点，agent节点和bootstrap节点都做了什么具体的工作"></a>在安装过程中，master节点，agent节点和bootstrap节点都做了什么具体的工作</h3><p>参照官网文档：<a href="https://dcos.io/docs/1.8/overview/architecture/" target="_blank" rel="noopener">https://dcos.io/docs/1.8/overview/architecture/</a></p>
<h3 id="DC-OS的安装脚本生成流程，以及安装流程"><a href="#DC-OS的安装脚本生成流程，以及安装流程" class="headerlink" title="DC/OS的安装脚本生成流程，以及安装流程"></a>DC/OS的安装脚本生成流程，以及安装流程</h3><p>dcos的源码下载下来后，根目录执行<code>build_local.sh</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Install the DC/OS tools</span><br><span class="line">./prep_local</span><br><span class="line"></span><br><span class="line"># Build a release of DC/OS</span><br><span class="line">release create `whoami` local_build</span><br></pre></td></tr></table></figure>
<p>第一步pre_local会执行setuptools的打包脚本，打包出一些需要的命令，比如release命令(python命令)<br>第二步就正式执行打包命令</p>
<ul>
<li>下载packages，编译，保存编译结果</li>
<li>把一些模板文件和配置文件初始化</li>
<li>把上述的文件根据Dockerfile，docker build出docker image的tar包</li>
<li>最终把docker image和脚本文件合并成为<code>dcos_generate_config.sh</code></li>
</ul>
<p>dcos_generate_config.sh是最初的安装脚本，由脚本和一个docker image二进制数据共同组成。</p>
<ul>
<li>脚本由dcos_generate_config.sh.in模板生成</li>
<li>docker image由配置的各个文件和Dockerfile，一起<code>docker build</code>后进行<code>docker save</code>的一个tar包。所以不能只看tar包信息，需要看<code>docker build</code>前的原始信息。</li>
</ul>
<p>执行<code>dcos_generate_config.sh --genconf</code>会生成配置文件，这一步会执行<code>docker run</code>，运行的就是docker image里的内容。那么要看如何生成配置文件，就需要看docker image是如何生成的。<br><code>dcos_generate_config.sh --genconf</code>在源码中的entry_point是<code>ext/dcos-installer/cli.py:main</code></p>
<p>综上，要抽出安装脚本中需要的部分：packages文件、配置文件以及安装脚本<br>其中packages文件要放到DIB中，配置文件无需改动的放到DIB中，安装脚本和部分需要改动的配置文件放在外面<br>对应到执行命令，就是<code>dcos_generate_config.sh --genconf</code>这个操作时，会变动的配置文件放到外面，其他的放到DIB中</p>
<ul>
<li>下载dcos源码，从头制作安装文件<br>这种需要重新下载和build各个packages包，还要初始化各个配置文件，耗时长，也有很多不确定因素会导致失败</li>
<li>直接下载编译好的dcos_generate_config.sh<br>这种需要执行<code>docker run</code>才能生成配置文件，依赖docker，但是解压文件后都是编译好的packages，节省时间，但是下载整个文件也需要花一定时间。</li>
</ul>
<p>制作DIB</p>
<ul>
<li>下载<code>dcos_generate_config.sh</code>，执行<code>dcos_generate_config.sh --genconf</code>，生成配置文件</li>
<li>找到安装过程脚本，单独执行，把packages文件和配置文件放置到对应位置，生成DIB</li>
</ul>
<p>magnum中的可配置文件</p>
<ul>
<li>找到生成配置文件的脚本，把ip-detect和cloud-config.yaml所影响的配置文件集中放置在magnum中，初始化这些模板文件后，拷贝到对应位置</li>
<li><code>ext/dcos-installer/cli.py:main</code></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/07/magnum-bay-create简析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengbeihong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fengbeihong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/07/magnum-bay-create简析/" itemprop="url">
                  Magnum Bay Create简析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-07 07:52:58 / Modified: 17:55:45" itemprop="dateCreated datePublished" datetime="2018-01-07T07:52:58+08:00">2018-01-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>magnum组件只有magnum-api和magnum-conductor两个服务，那么入手点就简单了，请求都传递给magnum-conductor来执行了。<br>下面是magnum的源码结构，已经去掉了一些不重要的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">magnum</span><br><span class="line">├── api # magnum-api服务的代码，http服务</span><br><span class="line">├── cmd # 命令行启动服务magnum-api、magnum-conductor或者初始化数据库，还有一个template_manage</span><br><span class="line">├── common # 通用操作</span><br><span class="line">├── conductor # magnum-conductor服务的代码</span><br><span class="line">├── db # 数据库信息</span><br><span class="line">├── drivers # 重点，执行操作都会定位到这里的代码和脚本</span><br><span class="line">├── objects # data model</span><br><span class="line">├── service # 一些额外的操作类，周期服务类等</span><br><span class="line">├── servicegroup # 同上</span><br><span class="line">├── templates # 原先放置heat模板文件的地方，后来统一改成了driver模式，就挪到了drivers目录下</span><br><span class="line">├── tests # 测试</span><br></pre></td></tr></table></figure></p>
<p>对于<code>magnum bay-create</code>操作，主要涉及conductor和drivers这两个目录的代码，<code>templates</code>还剩下一些东西，不过最终也要弃用。</p>
<p>drivers的目录有下面这些东西<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">drivers/</span><br><span class="line">├── common</span><br><span class="line">│   └── template_def.py # 模板定义的父类</span><br><span class="line">├── k8s_fedora_atomic_v1</span><br><span class="line">│   ├── template_def.py # 定义模板类</span><br><span class="line">│   ├── templates</span><br><span class="line">│   │   ├── elements # 创建image时可能用到的element</span><br><span class="line">│   │   ├── environments # 创建集群环境时，环境的配置</span><br><span class="line">│   │   ├── fragments # 创建集群环境时，可能要在heat模板里执行的一些脚本</span><br><span class="line">│   │   ├── kubecluster.yaml # 具体的heat template，这里是bay具体要执行哪些操作</span><br><span class="line">│   │   ├── kubemaster.yaml</span><br><span class="line">│   │   ├── kubeminion.yaml</span><br><span class="line">│   └── version.py</span><br><span class="line">├── k8s_coreos_v1</span><br><span class="line">├── mesos_ubuntu_v1</span><br><span class="line">└── swarm_fedora_atomic_v1</span><br></pre></td></tr></table></figure></p>
<p>可以看到当前magnum支持了三种docker集群，一共四种driver</p>
<ul>
<li>k8s_fedora_atomic_v1</li>
<li>k8s_coreos_v1</li>
<li>mesos_ubuntu_v1</li>
<li>mesos_ubuntu_v1</li>
</ul>
<p>要执行执行哪个driver，是有三个参数来决定的：<code>server_type</code>、<code>os</code>、<code>coe</code><br>每个driver里都会有一个<code>template_def.py</code>，这个就是来定义heat template的信息的类，类里主要做了3个操作：</p>
<ul>
<li>get_params # 要给heat template传递什么参数</li>
<li>get_env_files # 要在调用heat template时如何设置环境，主要是针对是否load balance时，执行了一些heat的resource_registry操作</li>
<li>template_path # 要执行的heat template的文件路径</li>
</ul>
<p>举个例子，对于<code>{&#39;server_type&#39;: &#39;bm&#39;, &#39;os&#39;: &#39;ubuntu&#39;, &#39;coe&#39;: &#39;mesos&#39;}</code>这样的参数，函数调用的堆栈信息如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">magnum/conductor/handlers/bay_conductor.py: Handler:bay-create</span><br><span class="line">magnum/conductor/handlers/bay_conductor.py: _create_stack</span><br><span class="line">magnum/conductor/handlers/bay_conductor.py: _extract_template_definition</span><br><span class="line">magnum/drivers/mesos_ubuntu_v1/template_def.py: TemplateDefinition:extract_definition</span><br><span class="line">最终调用 mesos_ubuntu_v1 对应的模板定义类 UbuntuMesosTemplateDefinition 里的三个函数</span><br></pre></td></tr></table></figure></p>
<p>参考：<br><a href="http://docs.openstack.org/developer/magnum/userguide.html#directory-structure" target="_blank" rel="noopener">Directory structure</a><br><a href="http://docs.openstack.org/developer/magnum/userguide.html#choosing-a-coe" target="_blank" rel="noopener">Choosing a coe</a><br><a href="http://docs.openstack.org/developer/magnum/troubleshooting-guide.html" target="_blank" rel="noopener">troubleshooting-guide</a></p>
<hr>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/07/UEFI-secure-boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengbeihong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fengbeihong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/07/UEFI-secure-boot/" itemprop="url">
                  UEFI Secure Boot
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-07 07:52:51 / Modified: 18:07:01" itemprop="dateCreated datePublished" datetime="2018-01-07T07:52:51+08:00">2018-01-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>linux的boot有一套流程：<code>firware-&gt;media-&gt;bootloader-&gt;kernel(kernel module)-&gt;init</code></p>
<ul>
<li>firmware发现可启动media，加载media（远程启动等）</li>
<li>bootloader从boot media加载kernel到RAM里，然后启动（会根据硬盘分区表之类的发现kernel，然后继续加载kernel module之类）</li>
<li>kernel会根据bootloader传递给kernel的指令去找到主文件系统</li>
<li>启动文件系统中的init脚本</li>
</ul>
<p>在第二步，uefi找到硬盘分区表后，发现文件系统，然后会开始加载kernel<br>如何加载，在按照系统时就已经确定好efi命令文件的路径，然后UEFI会执行这个程序<br>执行<code>efibootmgr</code>命令可以看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># efibootmgr -v</span><br><span class="line">BootCurrent: 0004</span><br><span class="line">Timeout: 5 seconds</span><br><span class="line">BootOrder: 0001,0004,0000,0003,0002</span><br><span class="line">Boot0000* EFI VMware Virtual IDE Hard Drive (IDE 0:0)   ACPI(a0341d0,...</span><br><span class="line">Boot0001* EFI VMware Virtual SATA CDROM Drive (1.0)     ACPI(a0341d0,...</span><br><span class="line">Boot0002* EFI Network   ACPI(a0341d0,0)PCI(12,0)MAC(000c29cf6279,0)</span><br><span class="line">Boot0003* EFI Internal Shell (Unsupported option)       MM(b,bee94000,...</span><br><span class="line">Boot0004* Red Hat Enterprise Linux    HD(spec)File(\EFI\redhat\shim.efi)</span><br></pre></td></tr></table></figure>
<p>对于readhat来说，efi相关文件结构如下.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># tree /boot/efi</span><br><span class="line">+-- EFI</span><br><span class="line">    +-- BOOT</span><br><span class="line">    |   +-- BOOTX64.EFI</span><br><span class="line">    |   +-- fallback.efi</span><br><span class="line">    +-- redhat</span><br><span class="line">        +-- BOOT.CSV</span><br><span class="line">        +-- fonts</span><br><span class="line">        |   +-- unicode.pf2</span><br><span class="line">        +-- gcdx64.efi</span><br><span class="line">        +-- grub.cfg</span><br><span class="line">        +-- grubx64.efi</span><br><span class="line">        +-- MokManager.efi</span><br><span class="line">        +-- shim.efi</span><br><span class="line">        +-- shim-redhat.efi</span><br><span class="line"></span><br><span class="line">4 directories, 10 files</span><br></pre></td></tr></table></figure>
<p>而当UEFI启动时，调用程序的流程是<code>UEFI-&gt;shim.efi-&gt;grubx64.efi-&gt;grub.cfg</code></p>
<p>查看<code>shim.efi</code>里的十六进制信息，可以看到调用<code>grubx64.efi</code>的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># hexdump -C /boot/efi/EFI/redhat/shim.efi | egrep -i -C 2 &apos;grub|g.r.u.b&apos;</span><br></pre></td></tr></table></figure>
<p>接着查看<code>grubx64.efi</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># strings /boot/efi/EFI/redhat/grubx64.efi | grep grub.cfg</span><br><span class="line">%s/grub.cfg</span><br></pre></td></tr></table></figure>
<p>到最后就到了执行grub的地方，或者叫做<code>Grand Unified Boot Loader</code><br>GRUB访问文件系统，找到kernel文件，加载到内存，然后启动kernel，传入一系列参数<br>kernel需要知道如何找到root目录，才能加载各种库和配置文件等，但是前提是要加载各种驱动后才可以做接下来的操作</p>
<p>那么下一步就是加载<code>/lib/modules</code>下的内核模块了</p>
<p>参考一个中文对linux boot的简介: <a href="http://blog.jobbole.com/33224/" target="_blank" rel="noopener">http://blog.jobbole.com/33224/</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/07/sign-kernel-module-for-secure-boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengbeihong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fengbeihong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/07/sign-kernel-module-for-secure-boot/" itemprop="url">
                  Sign Kernel Module for Secure Boot
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-07 07:52:44 / Modified: 18:08:29" itemprop="dateCreated datePublished" datetime="2018-01-07T07:52:44+08:00">2018-01-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="安装新的nvidia驱动遇到了内核模块签名的问题"><a href="#安装新的nvidia驱动遇到了内核模块签名的问题" class="headerlink" title="安装新的nvidia驱动遇到了内核模块签名的问题"></a>安装新的nvidia驱动遇到了内核模块签名的问题</h3><p>在linux系统里安装了nvidia的CUDA，然后在支持UEFI的系统里启动会报错。<br>检查发现，系统的新安装的驱动，即新添加的一些nvidia相关的kernel module没有被sign，在secure boot启动过程中check failed。</p>
<p>这里检查时主要有两个：一个是fedora文档，一个是nvidia文档</p>
<ul>
<li><p><a href="https://docs.fedoraproject.org/en-US/Fedora/22/html/System_Administrators_Guide/sect-signing-kernel-modules-for-secure-boot.html" target="_blank" rel="noopener">fedora文档</a></p>
</li>
<li><p><a href="http://us.download.nvidia.com/XFree86/Linux-x86/319.12/README/installdriver.html" target="_blank" rel="noopener">nvidia文档</a></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># sh ./NVIDIA-Linux-x86-319.12.run -s \</span><br><span class="line">--module-signing-secret-key=/path/to/signing.key \</span><br><span class="line">--module-signing-public-key=/path/to/signing.x509</span><br></pre></td></tr></table></figure>
<p>这里有说明用nvidia的runfile加参数，runfile会自动给你签名，但是安装CUDA的时候下载的runfile报错没有这些参数</p>
<p>顺便一说，CUDA的安装也有两种方式：rpm和runfile<br><a href="http://developer.download.nvidia.com/compute/cuda/7.5/Prod/docs/sidebar/CUDA_Quick_Start_Guide.pdf" target="_blank" rel="noopener">http://developer.download.nvidia.com/compute/cuda/7.5/Prod/docs/sidebar/CUDA_Quick_Start_Guide.pdf</a></p>
<p>在rpm方式下已经安装成功，因为rpm基本都是下载文件，然后安装文件，最后一步直接yum install cuda完成所有依赖的东西的安装</p>
<p>runfile的话则是先要进行一些配置文件的修改，有些命令会执行失败</p>
<hr>
<h3 id="手动siging-kernel-module的流程"><a href="#手动siging-kernel-module的流程" class="headerlink" title="手动siging kernel module的流程"></a>手动siging kernel module的流程</h3><h4 id="需要的tools"><a href="#需要的tools" class="headerlink" title="需要的tools"></a>需要的tools</h4><ul>
<li>openssl      openssl</li>
<li>sign-file    kernel-devel</li>
<li>perl         perl</li>
<li>mokutil      mokutil</li>
<li>keyctl       keyutils</li>
</ul>
<p>其中，openssl、sign-file和perl都是在build system里操作。<br>openssl用来生成密钥对，perl命令用来执行sign-file这个脚本文件，来给kernel module进行签名</p>
<p>mokutil和keyctl是在Target system执行。<br>mokutil用来enroll the public key，就是把公钥加到<code>MOK(Machine Owner Key)</code>表里。<br>keyctl用来显示<code>system key ring</code>里的公钥</p>
<blockquote>
<p>在build system里，不需要UEFI Secure Boot被enabled也不需要是一个支持UEFI的系统</p>
</blockquote>
<h4 id="kernel-module-authentication"><a href="#kernel-module-authentication" class="headerlink" title="kernel module authentication"></a>kernel module authentication</h4><p>fedora系统中，内核模块加载后，内核模块的签名signature会用存储在内核的system key ring里的公钥进行检查，包括检查白名单和黑名单。</p>
<p>在启动的时候，内核会从多处加载X.509 keys，加载到system key ring里，以便后面的对内核模块的check。<br>可以查看具体哪些source: <a href="https://docs.fedoraproject.org/en-US/Fedora/22/html/System_Administrators_Guide/sect-kernel-module-authentication.html#table-sources-for-system-key-rings" target="_blank" rel="noopener">Sources For System Key Rings</a></p>
<ul>
<li>Embedded in kernel</li>
<li>UEFI Secure Boot “db”</li>
<li>UEFI Secure Boot “dbx”</li>
<li>Embedded in shim.efi boot loader</li>
<li>Machine Owner Key (MOK) list</li>
</ul>
<p>kernel本身用户无法操作，UEFI的处于机器固件层面的，不好操作，就剩下shim.efi和MOK了。</p>
<p>在正常的系统中，shim.efi用户无法直接改动的，但在制作虚拟机镜像的时候，可以直接修改内核的所有文件，这时就可以替换或修改这个efi文件。<br>而通常情况下，比如在运行中的系统中，一般会用命令去操作MOK表，把前面步骤里生成的key注入到MOK中。</p>
<blockquote>
<ul>
<li>如果uefi secure boot没有启动或系统本身就不支持uefi secure boot，那么内核只会加载keys Embedded in kernel。</li>
<li>黑名单有更高优先级，如果存在于黑名单中了，那么就算内核模块以及签名也没用</li>
</ul>
</blockquote>
<p>下面是几个显示system key ring中密钥列表的命令例子：</p>
<p>UEFI Secure Boot is not enabled</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# keyctl list %:.system_keyring</span><br><span class="line">1 key in keyring:</span><br><span class="line"> 61139991: ---lswrv     0     0 asymmetric: Fedora kernel signing key: 1fc9e68f7419556348fdee2fdeb7ff9da6337b</span><br></pre></td></tr></table></figure>
<p>UEFI Secure Boot is enabled</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~]# keyctl list %:.system_keyring</span><br><span class="line">6 keys in keyring:</span><br><span class="line">...asymmetric: Red Hat Enterprise Linux Driver Update Program (key 3): bf57f3e87...</span><br><span class="line">...asymmetric: Red Hat Secure Boot (CA key 1): 4016841644ce3a810408050766e8f8a29...</span><br><span class="line">...asymmetric: Microsoft Corporation UEFI CA 2011: 13adbf4309bd82709c8cd54f316ed...</span><br><span class="line">...asymmetric: Microsoft Windows Production PCA 2011: a92902398e16c49778cd90f99e...</span><br><span class="line">...asymmetric: Red Hat Enterprise Linux kernel signing key: 4249689eefc77e95880b...</span><br><span class="line">...asymmetric: Red Hat Enterprise Linux kpatch signing key: 4d38fd864ebe18c5f0b7...</span><br></pre></td></tr></table></figure>
<p>可以查看kernel console messages，查看密钥是从哪里加载进来的。示例中是搜索从efi文件加载的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]# dmesg | grep &apos;EFI: Loaded cert&apos;</span><br><span class="line">[5.160660] EFI: Loaded cert &apos;Microsoft Windows Production PCA 2011: a9290239...</span><br><span class="line">[5.160674] EFI: Loaded cert &apos;Microsoft Corporation UEFI CA 2011: 13adbf4309b...</span><br><span class="line">[5.165794] EFI: Loaded cert &apos;Red Hat Secure Boot (CA key 1): 4016841644ce3a8...</span><br></pre></td></tr></table></figure>
<h4 id="kernel-module在启动过程中的规则"><a href="#kernel-module在启动过程中的规则" class="headerlink" title="kernel module在启动过程中的规则"></a>kernel module在启动过程中的规则</h4><p>kernel module在启动过程中可能被检测，因为还要依托于一个参数<code>module.sig_enforce</code>。</p>
<p>kernel module在启动过程中的整体流程</p>
<p>key是否强制加载，是否找到，是否验证通过，是否支持uefi secure boot，内核模块是否加载成功，内核是否被污染</p>
<p><a href="https://docs.fedoraproject.org/en-US/Fedora/22/html/System_Administrators_Guide/sect-kernel-module-authentication-requirements.html#table-kernel-module-authentication-requirements-for-loading" target="_blank" rel="noopener">Kernel Module Authentication Requirements for Loading</a></p>
<h4 id="生成密钥"><a href="#生成密钥" class="headerlink" title="生成密钥"></a>生成密钥</h4><ul>
<li>用openssl生成X.509密钥对<br>执行命令时依赖一个配置文件，要先创建一个配置文件(尖括号括起来的需要手动修改)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~]# cat &lt;&lt; EOF &gt; configuration_file.config</span><br><span class="line">[ req ]</span><br><span class="line">default_bits = 4096</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">prompt = no</span><br><span class="line">string_mask = utf8only</span><br><span class="line">x509_extensions = myexts</span><br><span class="line"></span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line">O = &lt;Organization&gt;</span><br><span class="line">CN = &lt;Organization signing key&gt;</span><br><span class="line">emailAddress = &lt;E-mail address&gt;</span><br><span class="line"></span><br><span class="line">[ myexts ]</span><br><span class="line">basicConstraints=critical,CA:FALSE</span><br><span class="line">keyUsage=digitalSignature</span><br><span class="line">subjectKeyIdentifier=hash</span><br><span class="line">authorityKeyIdentifier=keyid</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>执行openssl命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]# openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 \</span><br><span class="line">&gt; -batch -config configuration_file.config -outform DER \</span><br><span class="line">&gt; -out public_key.der \</span><br><span class="line">&gt; -keyout private_key.priv</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意保护私钥</p>
</blockquote>
<h4 id="把生成的密钥加入到target-system的多种途径"><a href="#把生成的密钥加入到target-system的多种途径" class="headerlink" title="把生成的密钥加入到target system的多种途径"></a>把生成的密钥加入到target system的多种途径</h4><p>因为内核从多处加载密钥，所以也有多种方式放置密钥</p>
<ul>
<li><p>让服务器硬件厂商把你自己生成的密钥加入到他们自己的固件镜像的UEFI Secure Boot key database</p>
<blockquote>
<p>有db和dbx两种database，内核加载是会过滤掉dbx中的失效key(revoked key)</p>
</blockquote>
</li>
<li><p><a href="https://docs.fedoraproject.org/en-US/Fedora/22/html/System_Administrators_Guide/sect-executable-key-enrollment-image-adding-public-key.html" target="_blank" rel="noopener">Executable Key Enrollment Image Adding Public Key</a><br>没太理解，应该是是编辑一个已有的image</p>
</li>
<li><p>手动把public key加入到MOK list<br>MOK是fedora里的一个功能，The MOK facility is supported by shim.efi, MokManager.efi, grubx64.efi, and the Fedora mokutil utility.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# mokutil --import my_signing_key_pub.der</span><br></pre></td></tr></table></figure>
<p>reboot the machine</p>
<p>MOK key enrollment的请求会被shim.efi注意到，然后它会调用MokManager.efi，从UEFI console完成密钥的登记。这时候你需要输入你刚才mokutil命令输入的密码</p>
<blockquote>
<p>对于ironic的user image怎么办？？，无法启动，是否会在image加载后，启动时完成enrollment??</p>
</blockquote>
<h4 id="Signing-Kernel-Module-with-the-Private-Key"><a href="#Signing-Kernel-Module-with-the-Private-Key" class="headerlink" title="Signing Kernel Module with the Private Key"></a>Signing Kernel Module with the Private Key</h4><ul>
<li>编译出来module(或者其他方式生成的module)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# make -C /usr/src/kernels/$(uname -r) M=$PWD modules</span><br></pre></td></tr></table></figure>
<ul>
<li>执行perl脚本，签名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]# perl /usr/src/kernels/$(uname -r)/scripts/sign-file \</span><br><span class="line">&gt; sha256 \</span><br><span class="line">&gt; my_signing_key.priv \</span><br><span class="line">&gt; my_signing_key_pub.der \</span><br><span class="line">&gt; my_module.ko</span><br></pre></td></tr></table></figure>
<ul>
<li>可以用modinfo来查看module的信息，<a href="https://docs.fedoraproject.org/en-US/Fedora/22/html/System_Administrators_Guide/sec-Displaying_Information_About_a_Module.html" target="_blank" rel="noopener">链接</a></li>
</ul>
<h4 id="加载signed-kernel-module"><a href="#加载signed-kernel-module" class="headerlink" title="加载signed kernel module"></a>加载signed kernel module</h4><ul>
<li>首先确认系统本次启动中内核没有加载密钥，用命令来查看system keyring</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyctl list %:.system_keyring</span><br></pre></td></tr></table></figure>
<ul>
<li>像之前的步骤一样，把公钥登记到MOK中，准确点叫做请求登记</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# mokutil --import my_signing_key_pub.der</span><br></pre></td></tr></table></figure>
<ul>
<li>Reboot, and complete the enrollment at the UEFI console.</li>
<li>重启后，再次检查keyring</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyctl list %:.system_keyring</span><br></pre></td></tr></table></figure>
<ul>
<li>现在则可以正常的加载你的kernel module了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]# modprobe -v my_module</span><br><span class="line">insmod /lib/modules/3.17.4-302.fc21.x86_64/extra/my_module.ko</span><br><span class="line">~]# lsmod | grep my_module</span><br><span class="line">my_module 12425 0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有个疑问，这里内核模块没有签名，则该内核模块加载失败，</p>
</blockquote>
<h4 id="kernel-modules-and-their-utilities"><a href="#kernel-modules-and-their-utilities" class="headerlink" title="kernel modules and their utilities"></a>kernel modules and their utilities</h4><p>一些内核相关的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lsmod(8) — The manual page for the lsmod command.</span><br><span class="line">modinfo(8) — The manual page for the modinfo command.</span><br><span class="line">modprobe(8) — The manual page for the modprobe command.</span><br><span class="line">rmmod(8) — The manual page for the rmmod command.</span><br><span class="line">ethtool(8) — The manual page for the ethtool command.</span><br><span class="line">mii-tool(8) — The manual page for the mii-tool command.</span><br></pre></td></tr></table></figure>
<h3 id="回到对ironic-user-image的签名"><a href="#回到对ironic-user-image的签名" class="headerlink" title="回到对ironic user image的签名"></a>回到对ironic user image的签名</h3><p>回到实际的场景，对添加了nvidia kernel module的image进行签名，有以下几种可操作的方法：</p>
<ul>
<li>使用自签名，那么使用命令操作MOK后，系统文件里就包含密钥了，但是需要把这个密钥最终写入到uefi主板上，这一步需要在系统启动时手动操作，所以无法自动化。</li>
<li>使用已有签名，就是uefi主板的数据库里已经带了默认密钥，是在出厂时就写入的官方公钥。所以如果想想一个内核模块加载成功，就需要这个内核模块被官方的私钥签名，但是这个操作个人是无法做的，只能由fedora官方来做。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/07/如何向openstack提交代码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengbeihong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fengbeihong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/07/如何向openstack提交代码/" itemprop="url">
                  如何向openstack提交代码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-07 07:51:48 / Modified: 17:50:08" itemprop="dateCreated datePublished" datetime="2018-01-07T07:51:48+08:00">2018-01-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前一直在向内网git库提交代码，最近终于要向社区提交了，鼓捣下流程。</p>
<p>提交代码的官方文档：<br><a href="http://docs.openstack.org/infra/manual/developers.html" target="_blank" rel="noopener">http://docs.openstack.org/infra/manual/developers.html</a></p>
<p>大体就是代码修改完成之后，<code>git add</code>，<code>git commit</code>, <code>git review</code></p>
<p><code>git review</code>会把代码提交到 <a href="https://review.openstack.org/" target="_blank" rel="noopener">https://review.openstack.org/</a> 进行review，review回归测试跑过了，然后被别人+2后就merge了。</p>
<h3 id="提交前的账号信息准备"><a href="#提交前的账号信息准备" class="headerlink" title="提交前的账号信息准备"></a>提交前的账号信息准备</h3><p>注册账号这里有些坑，虽然官方文档写的比较详细，但是仍然会不小心漏掉一点细节，就会导致<code>git review</code>失败。<br>所以一定要仔细看每一行字：<a href="http://docs.openstack.org/infra/manual/developers.html#account-setup" target="_blank" rel="noopener">http://docs.openstack.org/infra/manual/developers.html#account-setup</a></p>
<p>这里列出几处注册账号时必须做的事情：</p>
<ul>
<li><a href="https://launchpad.net/" target="_blank" rel="noopener">https://launchpad.net/</a> 网站的账号注册</li>
<li><a href="https://www.openstack.org/join/" target="_blank" rel="noopener">https://www.openstack.org/join/</a> 账号注册，选择foundation member类型，文档也有说明（一不小心就漏了）</li>
<li><a href="https://review.openstack.org/" target="_blank" rel="noopener">https://review.openstack.org/</a> 注册，其实是和launchpad关联，只用launchpad ID进行单点登录</li>
<li><a href="https://review.openstack.org/#/settings/" target="_blank" rel="noopener">https://review.openstack.org/#/settings/</a> 用户名设置，设置后不能修改，慎重</li>
<li><a href="https://review.openstack.org/#/settings/agreements" target="_blank" rel="noopener">https://review.openstack.org/#/settings/agreements</a> 同意license协议</li>
<li><a href="https://review.openstack.org/#/settings/ssh-keys" target="_blank" rel="noopener">https://review.openstack.org/#/settings/ssh-keys</a> 如果是ssh提交方式，上传本机ssh-key</li>
<li><a href="https://review.openstack.org/#/settings/http-password" target="_blank" rel="noopener">https://review.openstack.org/#/settings/http-password</a> 如果是https提交方式，生成密码(如果密码字符里有/就再生成一次，因为这个字符在git设置时会出错)</li>
</ul>
<h3 id="提交代码的验证方式"><a href="#提交代码的验证方式" class="headerlink" title="提交代码的验证方式"></a>提交代码的验证方式</h3><p>社区提供了两种提交代码的方式<code>ssh</code>和<code>https</code><br>由于国内的网络原因，使用ssh总是会出各种各样的问题，可以直接用https方式来提交，省时省力</p>
<p>先下载一个project的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://git.openstack.org/openstack/&lt;projectname&gt;.git</span><br><span class="line">cd &lt;projectname&gt;</span><br></pre></td></tr></table></figure></p>
<p>ssh提交方式，直接提交<br>https提交方式，则需要设置一下，主要是自己的username和上述步骤中生成的password<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add gerrit https://&lt;username&gt;:&lt;password&gt;@review.openstack.org/&lt;umbrella repository name&gt;/&lt;repository name&gt;.git</span><br></pre></td></tr></table></figure></p>
<p>这样在项目的配置<code>remote.gerrit.url</code>就会有值了</p>
<h3 id="如何下载他人或者自己以前的patch"><a href="#如何下载他人或者自己以前的patch" class="headerlink" title="如何下载他人或者自己以前的patch"></a>如何下载他人或者自己以前的patch</h3><p>经常会遇到这样的情况，看到别人的patch希望自己下载下来改下，提交自己修改的东西<br>或者是自己的patch，但是本地文件夹被删除了，希望再次在本地修改</p>
<p>看到网上最简单的一种就是，直接使用<code>git review</code>命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &lt;projectname&gt;</span><br><span class="line">git review -d &lt;review_id&gt;</span><br><span class="line">git review -d &lt;change_id&gt;</span><br></pre></td></tr></table></figure></p>
<p>还有就是可以根据gerrit网页右上角的Download提供的几种下载命令，把patch下载到本地</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/01/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengbeihong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fengbeihong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/01/hello-world/" itemprop="url">
                  Hello World
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2018-01-01T00:00:00+08:00">2018-01-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-07 10:34:10" itemprop="dateModified" datetime="2018-05-07T10:34:10+08:00">2018-05-07</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">fengbeihong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fengbeihong</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

  

</body>
</html>
